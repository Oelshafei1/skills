# 錯誤代碼對照表

本文檔列出藍新金流 API 可能回傳的所有錯誤代碼及其說明。

## 如何使用

當交易失敗時,`Status` 欄位會回傳錯誤代碼而非 `SUCCESS`。請參照下表找出錯誤原因並進行對應處理。

## MPG 交易錯誤 (MPG01xxx ~ MPG05xxx)

### MPG01xxx - 參數驗證錯誤

| 錯誤代碼 | 錯誤原因 | 相關參數 |
|---------|---------|---------|
| MPG01002 | 時間戳記不可空白 | TimeStamp |
| MPG01005 | TokenTerm不可空白/設定錯誤 | TokenTerm |
| MPG01008 | 分期參數設定錯誤 | InstFlag |
| MPG01009 | 商店代號不可空白 | MerchantID |
| MPG01010 | 程式版本設定錯誤 | Version |
| MPG01011 | 回傳規格設定錯誤 | RespondType |
| MPG01012 | 商店訂單編號不可空白/設定錯誤 (限英數字底線,長度30字) | MerchantOrderNo |
| MPG01013 | 付款人電子信箱設定錯誤 | Email |
| MPG01014 | 網址設定錯誤 | ReturnURL, NotifyURL, CustomerURL, ClientBackURL |
| MPG01015 | 訂單金額不可空白/設定錯誤,或超過商店單筆金額限制 | Amt |
| MPG01016 | 檢查碼不可空白 | CheckValue |
| MPG01017 | 商品資訊不可空白 | ItemDesc |
| MPG01018 | 繳費有效期限設定錯誤 | ExpireDate |
| MPG01023 | 交易加密資料不可空白 | TradeInfo |
| MPG01024 | 交易加密SHA資料不可空白 | TradeSha |
| MPG01025 | 金融機構格式錯誤 (僅接受大小寫英文&半形逗號) | BankType |
| MPG01026 | 金融機構格式錯誤,不接受XXX參數 (帶入的銀行有誤) | BankType |
| MPG01027 | 一銀維護中,請選擇其他金融機構 | BankType |
| MPG01028 | 訂單細項格式錯誤 | OrderDetail |
| MPG01029 | 訂單金額與訂單細項總金額不相符 | Amt, OrderDetail |
| MPG01030 | 訂單細項品項編號不可重複 | OrderDetail.ItemOrderNo |

### MPG02xxx - 商店設定錯誤

| 錯誤代碼 | 錯誤原因 | 說明 |
|---------|---------|------|
| MPG02001 | 檢查碼錯誤 | CheckValue 驗證失敗 |
| MPG02002 | 查無商店開啟任何金流服務 | 請至商店後台啟用支付方式 |
| MPG02003 | 支付方式未啟用 | 請洽客服中心 |
| MPG02004 | 已過匯率鎖定時限,請重新交易 | 匯率時間戳記不存在 |
| MPG02005 | 驗證資料錯誤(來源不合法) | - |
| MPG02006 | 信用卡收單機構系統發生異常 | 請洽客服中心 |
| MPG02007 | 本商店強制指定需檢核轉出行,請先啟用智慧ATM2.0服務 | SourceType |
| MPG02008 | SourceType參數錯誤,本商店強制指定需檢核轉出行 | SourceType值非2 |
| MPG02009 | 不可修改銀行代號與帳號時,須提供指定轉帳的銀行代號與帳號 | SourceBankId, SourceAccountNo |
| MPG02010 | 此版本不支援,請升級至v2.3 | Version |

### MPG03xxx - 交易處理錯誤

| 錯誤代碼 | 錯誤原因 | 說明 |
|---------|---------|------|
| MPG03001 | FormPost加密失敗 | - |
| MPG03002 | 拒絕交易IP | IP被封鎖 |
| MPG03003 | IP交易次數限制 | N分鐘內不可交易達M次 |
| MPG03004 | 商店狀態已被暫停或關閉 | 無法進行交易 |
| MPG03005 | 回傳參數資料不存在/解密失敗 | - |
| MPG03006 | 回傳參數資料不存在/解密失敗 | - |
| MPG03007 | 該筆訂單交易資訊不存在或查無此商店代號 | 物流服務相關 |
| MPG03008 | 已存在相同的商店訂單編號或TradeInfo與MerchantID不一致 | - |
| MPG03009 | 交易失敗 | 可能原因: SHA256檢查不符、TradeInfo解密失敗、EncryptType錯誤、銀行授權失敗 |
| MPG03010 | 驗證資料不存在或錯誤 | 玉山Wallet、台灣Pay、BitoPay錯誤 |
| MPG03011 | 訂單資料已不存在,請重新交易 | 玉山Wallet、台灣Pay、BitoPay錯誤 |

### MPG05xxx - 信用卡特定錯誤

| 錯誤代碼 | 錯誤原因 | 說明 |
|---------|---------|------|
| MPG05001 | 未有信用卡驗證資料或解密失敗 | - |
| MPG05002 | 信用卡卡號長度不足或未有商店代號 | - |
| MPG05003 | 信用卡不支援該付款方式 | 可能是不支援一次付清、分期或紅利 |
| MPG05004 | 發卡行暫時無法提供信用卡分期付款服務 | - |
| MPG05005 | 警示交易 | - |
| MPG05006 | 物流設定參數[LgsType]錯誤 | 限輸入C2C或B2C |
| MPG05007 | 請開啟其他支付方式,才能使用超商取貨不付款服務 | - |
| MPG05008 | 因金額限制關係,無法使用物流服務 | 訂單金額需<20,000元 |
| MPG05009 | 超商取貨服務未啟用[服務型態] | 請洽客服中心 |

## 交易處理錯誤 (TRA1xxxx ~ TRA2xxxx)

### TRA10xxx - 一般交易錯誤

| 錯誤代碼 | 錯誤原因 |
|---------|---------|
| TRA10001 | 商店資料取得失敗 |
| TRA10003 | 金額必須為數字 |
| TRA10008 | 資料加密錯誤 (PostData_解密失敗) |
| TRA10009 | 商店代號不可空白 |
| TRA10012 | 商店代號停用 |
| TRA10013 | 商店信用卡資格停用 |
| TRA10015 | 網路連線失敗 |
| TRA10018 | 資料不足 |
| TRA10021 | 查無該筆交易或該筆交易不為信用卡交易 |
| TRA10026 | 此訂單非授權成功狀態,不可請款 |
| TRA10027 | 此訂單已申請過請款,不可重覆請款 |
| TRA10028 | 請退款金額超過授權金額 |
| TRA10029 | 請款超過授權日N天,已不得請(退)款 |
| TRA10030 | 請款/退款資料新增失敗或模擬信用卡請款失敗 |
| TRA10031 | 銀聯卡交易只接受全額請款 |
| TRA10032 | 單號類型只能為數字1或2 (1=商店訂單 2=交易序號) |
| TRA10033 | 選擇使用商店自訂單號不可空白 |
| TRA10035 | 該交易非授權成功或已請款完成狀態 |
| TRA10036 | RespondType欄位格式錯誤或已超過剩餘可退款金額 |
| TRA10037 | 商家自訂單號錯誤,只允許英數字及_符號 |
| TRA10038 | 選擇使用系統單號格式錯誤 |
| TRA10039 | 退款金額已超過請款金額 |
| TRA10041 | 網址格式錯誤 |
| TRA10045 | 該筆交易正在退款中或退款失敗 |
| TRA10046 | 該筆交易撥款狀態異常,無法執行退款 |
| TRA10047 | 該交易不為授權成功狀態或尚未發動撥款 |
| TRA10048 | 該交易正在請款狀態 |
| TRA10049 | 該交易正在退款狀態 |
| TRA10050 | 金額不符 |
| TRA10051 | 取消授權失敗 |
| TRA10054 | 檢查碼CheckValue有錯誤 |
| TRA10058 | 動態貨幣轉換交易只接授全額請款 |
| TRA10070 | 銀聯卡交易無需請款 |
| TRA10071 | 因查無交易資料次數已達上限,已鎖定交易查詢功能 (待4小時解鎖) |
| TRA10077 | 只能退未撥金額 |
| TRA10094 | 資料取消失敗 |
| TRA10095 | 此筆交易已過關帳時間,不可取消 |
| TRA10675 | 紅利交易只接授全額請退款 |
| TRA10678 | 銀聯卡退款失敗 |
| TRA10702 | 因達到執行請退款筆數上限,暫時無法使用 (待1小時解鎖) |

### TRA11xxx, TRA20xxx - 進階交易錯誤

| 錯誤代碼 | 錯誤原因 |
|---------|---------|
| TRA11002 | 因失敗過多暫時無法使用本功能 (待4小時解鎖) |
| TRA20001 | 金融機構取消授權批次處理中 |
| TRA20002 | 查無交易資料 |
| TRA20004 | 商店訂單編號重覆 |
| TRA20011 | 該筆交易已請款 |
| TRA20027 | 此訂單已申請過退款,退款中 |
| TRA20028 | 可退款金額不足 |
| TRA40014 | TimeStamp欄位錯誤 |

## 電子錢包退款錯誤 (11xx)

| 錯誤代碼 | 錯誤原因 |
|---------|---------|
| 1101 | 退款失敗 |
| 1102 | 查無商店 |
| 1103 | 查無訂單資料 |
| 1104 | 訂單狀態不為可退款狀態 |
| 1105 | 可退金額不足 |
| 1106 | 錢包類型不符 |
| 1107 | 尚未請款 |
| 1108 | 僅支援全額退款 |
| 1109 | 退款交易申請中,請稍後 |
| 1110 | 商店支付方式未啟用 |
| 1111 | 查詢商店閘道設定,查無資料 |
| 1116 | 可退款金額不足 |

## 其他錯誤

| 錯誤代碼 | 錯誤原因 |
|---------|---------|
| ACC10005 | 會員已被暫時停權/永久停權 |
| MEM40008 | 必填欄位資料不可空白 |
| MEM40012 | 必填欄位資料傳遞錯誤 (PostData_空白) |
| MEM40013 | 必填欄位資料不齊全 |
| MEM40014 | 傳送時間錯誤 |
| NOR1001 | 連線異常 |
| 2100 | 最低金額為1 (The Amount minimum is 1) |
| 4101 | EncryptData_ 不可為空白 |
| 4102 | HashData_ 不可為空白 |
| 4103 | HashData_ 資料檢查不符合 |
| 4104 | 加密資料有誤 |

## 錯誤處理建議

### 常見錯誤處理流程

```php
<?php
function handle_newebpay_error($status, $message) {
    $error_actions = [
        // 參數錯誤 - 檢查程式碼
        'MPG01' => '請檢查請求參數格式',
        
        // 商店設定錯誤 - 聯繫客服
        'MPG02' => '請聯繫藍新金流客服檢查商店設定',
        
        // 交易處理錯誤 - 重試或記錄
        'MPG03' => '交易處理失敗,請稍後重試',
        
        // 信用卡特定錯誤 - 提示消費者
        'MPG05' => '信用卡交易失敗,請換張卡片或使用其他支付方式',
        
        // 交易狀態錯誤 - 檢查訂單
        'TRA1' => '交易狀態異常,請檢查訂單狀態',
        'TRA2' => '交易狀態異常,請檢查訂單狀態',
        
        // 電子錢包錯誤 - 檢查退款條件
        '11' => '電子錢包退款失敗,請檢查退款條件',
    ];
    
    // 取錯誤代碼前綴
    foreach ($error_actions as $prefix => $action) {
        if (strpos($status, $prefix) === 0) {
            log_error("藍新金流錯誤: {$status} - {$message}");
            return [
                'error' => true,
                'status' => $status,
                'message' => $message,
                'action' => $action
            ];
        }
    }
    
    // 未知錯誤
    return [
        'error' => true,
        'status' => $status,
        'message' => $message,
        'action' => '發生未知錯誤,請聯繫技術支援'
    ];
}

// 使用範例
$result = handle_newebpay_error('MPG01012', '商店訂單編號不可空白');
if ($result['error']) {
    echo "錯誤: {$result['message']}\n";
    echo "建議處理: {$result['action']}\n";
}
?>
```

### 重點提醒

1. **參數錯誤 (MPG01xxx)**: 
   - 仔細檢查請求參數格式
   - 確認必填欄位都有填寫
   - 注意參數長度和格式限制

2. **商店設定錯誤 (MPG02xxx)**:
   - 檢查商店後台設定
   - 確認支付方式已啟用
   - 聯繫客服協助處理

3. **交易處理錯誤 (MPG03xxx, TRA系列)**:
   - 記錄完整錯誤訊息
   - 實作重試機制 (避免重複訂單)
   - 適時聯繫技術支援

4. **信用卡錯誤 (MPG05xxx)**:
   - 提示消費者更換卡片
   - 建議使用其他支付方式
   - 注意卡片類型限制

5. **退款錯誤 (11xx, TRA10xxx)**:
   - 確認訂單狀態符合退款條件
   - 注意退款金額限制
   - 某些支付方式僅支援全額退款

## 測試建議

在測試環境中,可以刻意製造錯誤來測試錯誤處理機制:

- 故意傳送錯誤的參數格式
- 使用過期的時間戳記
- 傳送重複的訂單編號
- 測試各種支付方式的限制

這樣可以確保錯誤處理邏輯正確運作。
